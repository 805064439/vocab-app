<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLPT è¯æ±‡æŒ‘æˆ˜ (ä½¿ç”¨ Axios)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <style>
        /* ä½¿ç”¨ Inter å­—ä½“ä»¥è·å¾—ç°ä»£æ„Ÿ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* æµ…ç°è‰²èƒŒæ™¯ */
        }
        /* å¼ºè°ƒéƒ¨åˆ†æ ·å¼å®šä¹‰ï¼šç”¨é¢œè‰²å’Œä¸‹åˆ’çº¿ä»£æ›¿ç²—ä½“ */
        .highlight-word {
            color: #dc2626; /* Tailwind: text-red-600 */
            font-weight: 600; /* semi-boldç¨‹åº¦ */
            text-decoration: underline;
            text-decoration-color: #fca5a5; /* æµ…çº¢è‰²ä¸‹åˆ’çº¿ */
            text-underline-offset: 2px;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'accent-blue': '#3b82f6',
                        'accent-dark': '#1e293b',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-accent-dark mb-2">
                JLPT è¯æ±‡æŒ‘æˆ˜
            </h1>
            <p class="text-lg text-gray-500">
                æ¯æ¬¡ç‚¹å‡»è·å– 10 ä¸ªæ ¸å¿ƒè¯æ±‡ï¼Œæ”¯æŒ N5 è‡³ N1 èŒƒå›´é€‰æ‹©ã€‚
            </p>
        </header>

        <div class="flex flex-col sm:flex-row items-center justify-center mb-8 space-y-4 sm:space-y-0 sm:space-x-6">
            
            <div class="flex flex-col sm:flex-row sm:space-x-6 bg-white p-4 rounded-xl shadow-md border border-gray-200 justify-center">
                
                <div class="flex items-center space-x-2 mb-4 sm:mb-0">
                    <label for="startLevelSelector" class="font-medium text-gray-700 whitespace-nowrap">èµ·å§‹ç­‰çº§ (è¾ƒç®€å•):</label>
                    <select id="startLevelSelector" class="p-2 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue transition duration-150">
                        <option value="N5">N5 - åˆçº§</option>
                        <option value="N4">N4 - åˆä¸­çº§</option>
                        <option value="N3" selected>N3 - ä¸­çº§</option>
                        <option value="N2">N2 - ä¸­é«˜çº§</option>
                        <option value="N1">N1 - é«˜çº§</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2">
                    <label for="endLevelSelector" class="font-medium text-gray-700 whitespace-nowrap">ç»“æŸç­‰çº§ (è¾ƒéš¾):</label>
                    <select id="endLevelSelector" class="p-2 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue transition duration-150">
                        <option value="N5">N5 - åˆçº§</option>
                        <option value="N4">N4 - åˆä¸­çº§</option>
                        <option value="N3">N3 - ä¸­çº§</option>
                        <option value="N2">N2 - ä¸­é«˜çº§</option>
                        <option value="N1" selected>N1 - é«˜çº§</option>
                    </select>
                </div>
            </div>

            <button id="fetchButton"
                    class="px-8 py-3 bg-accent-blue text-white font-semibold rounded-xl shadow-lg hover:bg-blue-600 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-accent-blue/50 disabled:bg-gray-400">
                âœ¨ è·å–æ–°è¯æ±‡
            </button>
        </div>

        <div id="statusMessage" class="text-center text-sm text-gray-600 mb-4"></div>

        <div id="vocabularyContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2 text-center text-gray-400 p-12 bg-white rounded-xl shadow-inner">
                ç‚¹å‡» "è·å–æ–°è¯æ±‡" æŒ‰é’®æ¥å¼€å§‹å­¦ä¹ å§ï¼
            </div>
        </div>
    </div>

    <script>
        // âš ï¸ å¿…å¡«ï¼šè¯·å°†æ­¤å¤„çš„ URL æ›¿æ¢ä¸ºæ‚¨çœŸå®çš„ Vercel åŸŸåï¼
        const API_URL_BASE = "https://vocab-api-server-on-vercel.vercel.app/api/n1-vocab";

        const fetchButton = document.getElementById('fetchButton');
        const startLevelSelector = document.getElementById('startLevelSelector');
        const endLevelSelector = document.getElementById('endLevelSelector');
        const statusMessage = document.getElementById('statusMessage');
        const vocabularyContainer = document.getElementById('vocabularyContainer');
        
        // è®¾ç½® Axios è¶…æ—¶æ—¶é—´ä¸º 60 ç§’ (60000 æ¯«ç§’)
        const FRONTEND_TIMEOUT_MS = 60000; 

        /**
         * æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯å¹¶å¯ç”¨/ç¦ç”¨æŒ‰é’®
         * @param {string} message - è¦æ˜¾ç¤ºçš„æ¶ˆæ¯
         * @param {boolean} isLoading - æ˜¯å¦æ­£åœ¨åŠ è½½
         */
        function setStatus(message, isLoading) {
            statusMessage.textContent = message;
            fetchButton.disabled = isLoading;
            
            const timeoutSeconds = FRONTEND_TIMEOUT_MS / 1000;
            fetchButton.textContent = isLoading 
                ? `ğŸš€ æ­£åœ¨å‘AIè¯·æ±‚æ•°æ® (è¯·è€å¿ƒç­‰å¾…ï¼Œæœ€é•¿ ${timeoutSeconds} ç§’)...` 
                : 'âœ¨ è·å–æ–°è¯æ±‡';
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ® JLPT ç­‰çº§è¿”å› Tailwind CSS é¢œè‰²ç±»
        function getLevelColorClasses(level) {
            switch (level.toUpperCase()) {
                case 'N5': return 'bg-blue-100 text-blue-700';
                case 'N4': return 'bg-cyan-100 text-cyan-700';
                case 'N3': return 'bg-green-100 text-green-700';
                case 'N2': return 'bg-yellow-100 text-yellow-700';
                case 'N1': return 'bg-red-100 text-red-700';
                default: return 'bg-gray-100 text-gray-700';
            }
        }

        /**
         * ä¾‹å¥æ ¼å¼åŒ–ï¼šå°†åŒæ˜Ÿå·ï¼ˆ**...**ï¼‰æ›¿æ¢ä¸ºé«˜äº®æ˜¾ç¤ºç”¨çš„ span æ ‡ç­¾ã€‚
         * æ­¤å‡½æ•°é€‚ç”¨äºæ—¥è¯­å’Œä¸­æ–‡ä¾‹å¥ã€‚
         * @param {string} sentence - åŸå§‹ä¾‹å¥å­—ç¬¦ä¸²
         * @returns {string} - æ›¿æ¢åçš„ HTML å­—ç¬¦ä¸²
         */
        function formatExampleSentence(sentence) {
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ /g æ›¿æ¢æ‰€æœ‰åŒ¹é…çš„ **...**ï¼Œå¹¶ç”¨ span æ ‡ç­¾åŒ…è£¹æ•è·ç»„ ($1)
            return sentence.replace(/\*\*(.*?)\*\*/g, '<span class="highlight-word">$1</span>');
        }

        /**
         * åˆ›å»ºå•ä¸ªè¯æ±‡å¡ç‰‡
         * @param {object} vocab - è¯æ±‡æ•°æ®å¯¹è±¡
         */
        function createCard(vocab) {
            const actualLevel = vocab.jlpt_level || 'æœªçŸ¥ç­‰çº§'; 
            const levelClasses = getLevelColorClasses(actualLevel);
            
            // ğŸ’¥ å…³é”®ä¿®æ”¹ï¼šåˆ†åˆ«å¯¹æ—¥è¯­ä¾‹å¥å’Œä¸­æ–‡ä¾‹å¥è¿›è¡Œæ ¼å¼åŒ–
            const formattedSentenceJp = formatExampleSentence(vocab.example_sentence_jp);
            const formattedSentenceCn = formatExampleSentence(vocab.example_sentence_cn);

            return `
                <div class="bg-white p-6 rounded-xl shadow-xl hover:shadow-2xl transition duration-300 border border-gray-100">
                    <div class="flex justify-between items-start mb-3 border-b pb-2 border-dashed">
                        <h3 class="text-3xl font-bold text-accent-dark tracking-wide">${vocab.word}</h3>
                        <div class="flex items-center space-x-3">
                            <span class="text-xs font-bold px-3 py-1 ${levelClasses} rounded-full shadow-inner whitespace-nowrap">
                                ${actualLevel}
                            </span>
                            <span class="text-lg text-gray-500 font-medium">${vocab.reading}</span>
                        </div>
                    </div>

                    <p class="text-lg text-gray-700 font-semibold mb-4">
                        <span class="text-accent-blue mr-2">è¯‘:</span> ${vocab.chinese_translation}
                    </p>

                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="text-base italic text-gray-800 mb-2">
                            ${formattedSentenceJp}
                        </p>
                        <p class="text-sm text-gray-500">
                            ${formattedSentenceCn}
                        </p>
                    </div>
                </div>
            `;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæå–ç­‰çº§çš„æ•°å­—éƒ¨åˆ†
        function getLevelNumber(levelString) {
            return parseInt(levelString.substring(1));
        }

        /**
         * ä» Vercel API è·å–è¯æ±‡æ•°æ®å¹¶æ¸²æŸ“ (ä½¿ç”¨ Axios)
         */
        async function fetchVocabulary() {
            setStatus('', true);
            vocabularyContainer.innerHTML = ''; 
            
            const startLevel = startLevelSelector.value;
            const endLevel = endLevelSelector.value;
            
            const startNum = getLevelNumber(startLevel);
            const endNum = getLevelNumber(endLevel);

            if (startNum < endNum) {
                const message = `âš ï¸ ç­‰çº§é€‰æ‹©é”™è¯¯ï¼šèµ·å§‹ç­‰çº§ (${startLevel}) å¿…é¡»ä½äºæˆ–ç­‰äºç»“æŸç­‰çº§ (${endLevel})ã€‚è¯·ç¡®ä¿é€‰æ‹©çš„èŒƒå›´æ˜¯ä»ç®€å•åˆ°å¤æ‚ (ä¾‹å¦‚ N3 åˆ° N1)ã€‚`;
                setStatus(message, false);
                vocabularyContainer.innerHTML = `<div class="md:col-span-2 text-center text-orange-600 p-12 bg-white rounded-xl shadow-inner">${message}</div>`;
                return;
            }

            const fullApiUrl = `${API_URL_BASE}?startLevel=${startLevel}&endLevel=${endLevel}`;

            try {
                setStatus(`æ­£åœ¨è¯·æ±‚ ${startLevel} åˆ° ${endLevel} èŒƒå›´è¯æ±‡...`, true);
                
                // æ ¸å¿ƒï¼šä½¿ç”¨ axios.getï¼Œå¹¶é…ç½® timeout
                const response = await axios.get(fullApiUrl, {
                    timeout: FRONTEND_TIMEOUT_MS, // è®¾ç½®è¶…æ—¶æ—¶é—´
                    // å…è®¸ 4xx/5xx çŠ¶æ€ç é€šè¿‡ï¼Œåœ¨ä¸‹é¢æ‰‹åŠ¨å¤„ç†
                    validateStatus: (status) => status >= 200 && status < 505 
                });
                
                const data = response.data;
                
                if (response.status !== 200) {
                     throw new Error(`HTTP é”™è¯¯ï¼çŠ¶æ€ç : ${response.status}. è¯¦æƒ…: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
                if (!data.n1_vocabulary_list || data.n1_vocabulary_list.length === 0) {
                     vocabularyContainer.innerHTML = `<div class="md:col-span-2 text-center text-red-500 p-12 bg-white rounded-xl shadow-inner">API è¿”å›çš„æ•°æ®æ ¼å¼æœ‰è¯¯æˆ–åˆ—è¡¨ä¸ºç©ºã€‚</div>`;
                     setStatus('è·å–å¤±è´¥', false);
                     return;
                }

                setStatus(`æˆåŠŸè·å– ${data.n1_vocabulary_list.length} ä¸ªè¯æ±‡ã€‚`, false);
                
                let cardsHtml = data.n1_vocabulary_list.map(vocab => createCard(vocab)).join('');
                vocabularyContainer.innerHTML = cardsHtml;

            } catch (error) {
                console.error("Axios Error:", error);
                
                let displayMessage;

                // é’ˆå¯¹ Axios è¶…æ—¶ã€499 å’Œå…¶ä»–é”™è¯¯è¿›è¡Œå¤„ç†
                if (axios.isCancel(error) || error.code === 'ECONNABORTED') {
                    displayMessage = `è¯·æ±‚è¶…æ—¶ï¼AI ç”Ÿæˆæ•°æ®è€—æ—¶è¶…è¿‡ ${FRONTEND_TIMEOUT_MS / 1000} ç§’ã€‚è¯·ç¨åé‡è¯•ã€‚`;
                } else if (error.message.includes('499')) {
                    displayMessage = `è·å–è¯æ±‡è¯·æ±‚ä¸­æ–­ (499 å¸¸è§æƒ…å†µ)ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚`;
                } else if (error.response) {
                    // Axios æ•è·åˆ°çš„é 2xx å“åº”
                    const status = error.response.status;
                    const errorDetail = error.response.data?.error || error.message;
                    displayMessage = `æœåŠ¡å™¨é”™è¯¯ (${status})ã€‚è¯¦æƒ…: ${errorDetail}`;
                } else {
                    displayMessage = `è·å–è¯æ±‡å¤±è´¥ã€‚è¯¦æƒ…: ${error.message}`;
                }

                setStatus(displayMessage, false);
                vocabularyContainer.innerHTML = `<div class="md:col-span-2 text-center text-red-500 p-12 bg-white rounded-xl shadow-inner">
                    é”™è¯¯: ${displayMessage}
                </div>`;
            }
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        fetchButton.addEventListener('click', fetchVocabulary);
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„å¤„ç†
        window.onload = () => {
             setStatus('ç‚¹å‡»æŒ‰é’®å¼€å§‹ã€‚', false);
        };
    </script>
</body>
</html>