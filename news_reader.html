<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日语每日新闻</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 设置 Tailwind 配置，使用 Inter 字体，并配置主题色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans CJK JP', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1D4ED8', // Tailwind blue-700
                        'japanese-red': '#E11D48', // Tailwind rose-600
                        'kanji-bg': '#F3F4F6',    // Tailwind gray-100
                    }
                }
            }
        }
    </script>
    <style>
        /* 隐藏滚动条，保持界面干净 */
        body {
            font-family: 'Inter', 'Noto Sans CJK JP', sans-serif;
            background-color: #f7f9fb;
        }
        /* Markdown 双星号高亮样式 */
        .news-content b {
            font-weight: 700;
            color: #E11D48; /* 使用日文红 */
            background-color: #FEE2E2; /* 浅红背景 */
            padding: 1px 4px;
            border-radius: 4px;
        }
        /* 确保链接和按钮的触控友好性 */
        .touch-target {
            min-height: 48px;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex justify-center items-start">
    <div id="app" class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-10 border border-gray-100">

        <!-- 头部标题 -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 border-b-4 border-primary-blue pb-2 inline-block">
                每日新闻学习
            </h1>
            <p class="mt-2 text-gray-500">使用 Gemini AI 提供的最新日语新闻和词汇解析</p>
        </header>

        <!-- 加载状态/错误/内容区 -->
        <div id="content-area">
            <div id="loading-indicator" class="text-center p-12 hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-blue mx-auto mb-3"></div>
                <p class="text-lg text-primary-blue">正在努力获取最新新闻...</p>
            </div>

            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative" role="alert">
                <strong class="font-bold">加载失败：</strong>
                <span id="error-text" class="block sm:inline"></span>
            </div>

            <!-- 新闻内容卡片将渲染到这里 -->
            <div id="news-card" class="hidden space-y-8">
                <!-- Title and Source -->
                <section class="border-b pb-4 border-gray-200">
                    <h2 id="news-title" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                    <a id="news-source" target="_blank" class="text-sm text-blue-500 hover:text-primary-blue hover:underline transition">
                        查看原始新闻来源
                    </a>
                </section>

                <!-- 日文原文部分 -->
                <section>
                    <h3 class="text-xl font-semibold text-gray-700 border-l-4 border-japanese-red pl-3 mb-4">
                        <span class="mr-2">🇯🇵</span> 日文原文 (News JP)
                    </h3>
                    <div id="news-jp" class="news-content text-lg text-gray-800 leading-relaxed bg-kanji-bg p-4 rounded-lg shadow-inner">
                        <!-- 日文内容 -->
                    </div>
                </section>

                <!-- 中文翻译部分 -->
                <section>
                    <h3 class="text-xl font-semibold text-gray-700 border-l-4 border-primary-blue pl-3 mb-4">
                        <span class="mr-2">🇨🇳</span> 中文翻译 (Translation CN)
                    </h3>
                    <div id="translation-cn" class="news-content text-base text-gray-600 leading-loose p-4 rounded-lg border border-gray-200">
                        <!-- 中文内容 -->
                    </div>
                </section>

                <!-- 词汇注音表 -->
                <section>
                    <h3 class="text-xl font-semibold text-gray-700 border-l-4 border-gray-500 pl-3 mb-4">
                        <span class="mr-2">📚</span> 重点词汇注音 (Reading Map)
                    </h3>
                    <div id="reading-map-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 注音列表将渲染到这里 -->
                    </div>
                </section>
            </div>
        </div>
        
        <!-- 刷新按钮 -->
        <footer class="mt-8 pt-6 border-t border-gray-200 text-center">
            <button id="refresh-button" class="touch-target bg-primary-blue hover:bg-blue-800 text-white font-semibold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-primary-blue focus:ring-opacity-50 flex items-center justify-center mx-auto" onclick="fetchDailyNewsData()">
                <svg id="refresh-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356 2H20V4m-2 2a8 8 0 11-13.39-4.87L4.5 7.5"></path></svg>
                重新加载最新新闻
            </button>
        </footer>

    </div>

    <script>
        // *** 修复点: 将 API_ENDPOINT 更改为完整的 HTTPS 链接 ***
        const API_ENDPOINT = 'https://vocab-api-server-on-vercel.vercel.app/api/daily-news';

        // 获取 DOM 元素
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const newsCard = document.getElementById('news-card');
        const newsTitle = document.getElementById('news-title');
        const newsSource = document.getElementById('news-source');
        const newsJp = document.getElementById('news-jp');
        const translationCn = document.getElementById('translation-cn');
        const readingMapContainer = document.getElementById('reading-map-container');
        const refreshButton = document.getElementById('refresh-button');
        
        /**
         * 辅助函数：将双星号格式的文本转换为 HTML bold 标签。
         * 作用是高亮显示 **词汇**。
         * @param {string} text - 包含 Markdown 双星号的文本。
         * @returns {string} - 包含 <b> 标签的 HTML 字符串。
         */
        function formatBoldText(text) {
            // 正则表达式匹配 **任意内容**
            return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        }

        /**
         * 渲染词汇注音表
         * @param {Record<string, string>} readingMap - 汉字词汇到片假名读音的映射表。
         */
        function renderReadingMap(readingMap) {
            readingMapContainer.innerHTML = '';
            const words = Object.keys(readingMap);

            if (words.length === 0) {
                readingMapContainer.innerHTML = '<p class="text-gray-500">本篇新闻未提供额外的词汇注音。</p>';
                return;
            }

            words.forEach(word => {
                const reading = readingMap[word];

                const item = document.createElement('div');
                item.className = 'flex flex-col bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-sm transition hover:shadow-md';
                item.innerHTML = `
                    <p class="text-sm font-medium text-gray-500 mb-1">词汇 (Kanji)</p>
                    <p class="text-2xl font-bold text-gray-900 mb-2">${word}</p>
                    <p class="text-sm font-medium text-gray-500 mb-1">读音 (Reading)</p>
                    <p class="text-lg text-japanese-red font-mono bg-white p-2 rounded-md border border-dashed border-japanese-red">
                        ${reading}
                    </p>
                `;
                readingMapContainer.appendChild(item);
            });
        }

        /**
         * 核心数据获取函数
         */
        async function fetchDailyNewsData() {
            // 1. 设置 UI 状态为加载中
            newsCard.classList.add('hidden');
            errorMessage.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            refreshButton.disabled = true;
            refreshButton.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                // 使用完整的 HTTPS URL
                const response = await fetch(API_ENDPOINT);

                if (!response.ok) {
                    // 处理 HTTP 错误 (例如 404, 500)
                    let errorDetails = `服务器返回错误代码: ${response.status}`;
                    try {
                        const errorJson = await response.json();
                        errorDetails = errorJson.error || errorDetails;
                    } catch (e) {
                        // 忽略非 JSON 响应的解析错误
                    }
                    throw new Error(errorDetails);
                }

                /** * @typedef {object} NewsItem
                 * @property {string} title_jp - 原始新闻标题
                 * @property {string} source_url - 原始新闻出处链接
                 * @property {string} news_jp - 日语正文，重要词汇用 **双星号** 标记
                 * @property {Record<string, string>} reading_map - 汉字词汇到片假名读音的映射表
                 * @property {string} translation_cn - 中文翻译，对应词汇用 **双星号** 标记
                 */
                /** @type {NewsItem} */
                const data = await response.json();

                // 2. 渲染新闻数据
                newsTitle.textContent = data.title_jp;
                
                // 设置链接
                newsSource.href = data.source_url;
                newsSource.textContent = `查看原始新闻来源 (${data.source_url.substring(0, 40)}...)`;

                // 渲染日文原文，并高亮重点词汇
                newsJp.innerHTML = formatBoldText(data.news_jp);
                
                // 渲染中文翻译，并高亮对应词汇
                translationCn.innerHTML = formatBoldText(data.translation_cn);
                
                // 渲染注音表
                renderReadingMap(data.reading_map);

                // 3. 显示新闻卡片
                newsCard.classList.remove('hidden');

            } catch (error) {
                // 4. 处理并显示错误信息
                console.error("获取新闻数据失败:", error);
                errorText.textContent = error.message;
                errorMessage.classList.remove('hidden');
                
            } finally {
                // 5. 无论成功还是失败，都隐藏加载指示器并启用按钮
                loadingIndicator.classList.add('hidden');
                refreshButton.disabled = false;
                refreshButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // 页面加载完成后立即获取数据
        window.onload = fetchDailyNewsData;
    </script>
</body>
</html>
